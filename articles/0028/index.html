<div id="article">
<h1>Implementing Java library management with the Ant tasks for Apache Maven</h1>
<p id="articlehead">The world of Java is one of open-source, common
components and rapid, evolving change. However, one of the caveats of
such a model is the time spent in managing library dependencies. In this
article In this section I will describe how this issue can be resolved
using Apache Ant and the Ant tasks for Apache Maven.</p>
<h2>The Java dependency management problem</h2>
<p>If you took a typical enterprise Java application and decomposed
it down into the libraries that were developed or reused to implement
it, you could easily find upwards of 100 different libraries (or .j<span
	style="font-style: italic;">ar</span> files). A number of these
libraries might be open source implementations, such as the Jakarta <a
	href="http://jakarta.apache.org/commons/">commons</a> libraries, others
might be commercial business components that you have sourced from a
third party. However, since many commercial components also make
extensive use of open source components themselves (and why wouldn't
they!), you can quite easily find yourself with duplicate sets of
libraries at different version levels!</p>
<p>When you are developing your own common libraries, you will
obviously also be creating multiple versions of them and will probably
need to support different versions for different projects, or for
projects in different phases. Following on from this, your library
dependencies might have dependencies on other libraries themselves (so
called <b>transitive dependencies</b>),
you will also need to manage and capture this kind of metadata too.</p>
<p>The typical ways that organizations solve this problem are to
create a shared repository of libraries - sometimes in version control
system, sometimes not. This approach can work but requires a significant
amount of administration to keep it up to date. This is especially true
for transitive dependencies where you would need to somehow store their
associative metadata alongside the components. Alternately you would
need to create a significant amount of baselines in your version control
system to refer to a compatible (and collective set) of libraries.</p>
<p>Fortunately, there are now a number of Java tools that can help you solve
this problem. These include Apache Maven (in the form of Ant tasks) and
<a href="http://incubator.apache.org/ivy">Apache Ivy</a>. Both can be made to
work with Ant, however since Maven could be seen as the next generation of
Java build tool, it is worth looking at its implementation first - doing so
will also give you a possible future upgrade path. In this article I will
therefore describe in detail how to implement library management with the
Ant tasks for Apache Maven.</p>

<h2>Installing the Ant tasks for Apache Maven</h2>

<p>The Ant tasks for Apache Maven are available as a Java library from the
Apache Maven website. You can download the latest version of the tasks from <a
href="http://maven.apache.org/download.html">http://maven.apache.org/download.html</a>.
There should be a single Java library. You can either install this library to
your Ant <span style="font-family: monospace;">lib</span>
directory (for example, <span
span style="font-family: monospace;">%ANT_HOME%\lib</span>)
or to a directory alongside your top-level <span style="font-family: monospace;">build.xml</span> file. I
prefer to install the Java library into a directory called <span style="font-family: monospace;">lib</span>
alongside the <span style="font-family: monospace;">build.xml</span> file, and
then place it under version control. </p>

<p>Once you have done this you will need to change your <span style="font-family: monospace;">build.xml</span>
to reference the tasks "namespace". You can achieve this by adding the
following to your top-level <span style="font-family: monospace;">&lt;project&gt;</span> element:</p>

<div id="codeoutput">&lt;project ...
xmlns:artifact=&quot;urn:maven-artifact-ant&quot;&gt;</div>

<p>Namespaces allow you to reference third party libraries
and their tasks. In this case the namespace being created is called "artifact" and refers
to the Uniform Resource Name (URN) "<span style="font-family: monospace;">maven-artifact-ant</span>".
In order for Ant to be able to locate this
URN, you will also need to define a Classpath where Ant can locate the library
as follows:</p>

<pre name="code" class="xml">
&lt;typedef uri=&quot;urn:maven-artifact-ant&quot;
    resource=&quot;org/apache/maven/artifact/ant/antlib.xml&quot;&gt;
    &lt;classpath&gt;
        &lt;pathelement location=&quot;${dir.lib}/
            maven-artifact-ant-2.x.x-dep.jar&quot;/&gt;
    &lt;/classpath&gt;
&lt;/typedef&gt;
</pre>

<p>This <span style="font-family: monospace;">&lt;typedef&gt;</span>
element references the Ant tasks for the Apache Maven Java library that you
have downloaded and installed &ndash; in this case in the <span style="font-family: monospace;">${dir.lib}</span>
directory.</p>

<h2>Using Apache Maven repositories</h2>

<p>Apache Maven uses file system repositories to store and
organize the Java libraries that you will be using as part of your build
process. Alongside the Java libraries themselves, it also stores metadata
representing their versions and dependencies. By default this repository is located
on the Internet at <a href="http://ibiblio.org/maven2">http://ibiblio.org/maven2</a>
(and is mirrored around the world), however you also can implement internal
repositories for your own organization. One obvious reason for wanting to do
this is for security purposes &ndash; you probably would not want to publish your
companies internally developed libraries on the Internet.</p>

<p>The basic structure of any Maven repository is relatively simple
and is illustrated in the diagram below:</p>

<div align="center"><img alt="Maven repository structure" src="%image_dir%/mavenrepo.gif"/></div>

<p>In this example I am focusing on a specific directory in
the Maven <i>ibiblio</i>
repository for the Jakarta
"commons-net"
component. This is a popular component which contains a
collection of network utilities and protocol implementations such as FTP, SMTP and Telnet. Inside the
<span style="font-family: monospace;">commons-net</span>
directory of the Maven repository is a sub-directory for every version of
"commons-net" that has
been released. Inside these sub-directories are three types of files:</p>

<ul>
<li>The Java libraries which contain the implemented
functionality. In the diagram above
there is only a single library called <span style="font-family: monospace;">commons-net-1.40.jar</span>
(although the directory could
contain several libraries).</li>
<li>The Project Object Model (POM) file for the component, in this
case <span style="font-family: monospace;">commons-net-1.4.0.pom</span>.</li>
<li>The <span style="font-family: monospace;">maven-metadata.xml</span> which is an internally managed file
used to mark out the fact that this is a Maven repository</li>
</ul>

<p>There will also be a number of checksum files that are managed by Maven as well.</p>

<p>Maven uniquely identifies each version of a library via its
filename, for example, <span style="font-family: monospace;">commons-net-1.4.0.jar</span>. However, it also
allows you to manage snapshots, which are the latest but unreleased versions of
libraries. Snapshots are marked via a "<span style="font-family: monospace;">&ndash;SNAPSHOT</span>" identifier in the
version name. Although Maven will help you manage these files in its
repository, creating checksums, directory structures and so on, it does not automatically
know about dependencies between libraries. This is where the POM file comes in.
</p>

<p>In the full version of Apache Maven, POM files replace <span style="font-family: monospace;">build.xml</span>
files as the build scripts - defining how to build a project or component. Included
in this file is the list of dependent libraries that are required for the build
to be successful. For example, if you looked at this file for <span style="font-family: monospace;">commons-net</span>
you would see that it contains the following lines:</p>

<pre name="code" class="xml">
&lt;project&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;commons-net&lt;/groupId&gt;
    &lt;artifactId&gt;commons-net&lt;/artifactId&gt;
    &lt;name&gt;Jakarta Commons Net&lt;/name&gt;
    &lt;version&gt;1.4.0&lt;/version&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;oro&lt;/groupId&gt;
            &lt;artifactId&gt;oro&lt;/artifactId&gt;
            &lt;version&gt;2.0.8&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</pre>

<p>In this example you can see that the initial elements
define information about the library and how to access it from within the
repository - via its "groupId"
and "artifiactId".
You can also see the set of additional libraries that this library is dependent
on; in this case it is the Jakarta ORO (regular expression) library version
2.0.8. You only really need to be concerned with the content of POM files if
you are going to be creating your own Java libraries and publishing them to the
Maven repository. If this is the case then you will need to create POM files for each component that you wish to
publish. I will discuss how to achieve this later.</p>

<p>The way that the Apache Maven dependency
management feature works is that when you carry out a build, it cycles through
all these dependencies and downloads the appropriate versions from the site
repository to a user’s local repository (by default this repository is called "<span style="font-family: monospace;">.m2</span>"
and is located in your home directory). The local repository is essentially
your own personal cache &ndash; and is automatically maintained &ndash; you do not need to
do anything to update or refresh it.</p>

<h2>Implementing your own repository</h2>

<p>If you want to make use of the Internet repository then
you need to do nothing to specify the location of the library repository.
However, if you wish to implement your own site based repository, along side or
instead of the Internet repository, then you need to specify the location of
this repository in your <span style="font-family: monospace;">build.xml</span>
file. You can achieve this by including a line similar to the following:</p>

<div id="codeoutput">&lt;artifact:remoteRepository
id=&quot;internal.repository&quot; url=&quot;http://myhost/maven2&quot;/&gt;</div>

<p>In this example an internal repository is being used
which is accessible via a Web server on the local Intranet at <span style="font-family: monospace;">http://myhost.maven2</span>.
This repository is going to be referenced using the id "<span style="font-family: monospace;">internal.repository</span>".
If you do not have a Web server you can still specify a URL for a file system
location, for example, <span style="font-family: monospace;">file:///shared/maven2</span>.</p>

<p>You can initialize your own repository by simply creating an
empty directory on a file system. If you have an existing set of internally
developed Java libraries then you can import them into your repository using
the Apache Maven <span style="font-family: monospace;">deploy</span> command. For example, to install the Java library
<span style="font-family: monospace;">HotelDJEJBClient.jar</span>
at version 1.0.1 you would use the following command:</p>

<div id="codeoutput">mvn deploy:deploy-file -DgroupId=hoteldejava<br>
-DartifactId=hoteldejavaejbclient -Dversion=1.0.1<br>
-Dpackaging=jar -Dfile=./HotelDJEJBClient.jar<br>
-DrepositoryId=repository -Durl=file:///shared/maven2</div>

<p>In order to use this command you will need to download Apache
Maven itself
since it requires the "<span style="font-family: monospace;">mvn</span>"
binary. One particular point to consider is that only open source libraries are
contained in the ibiblio repository, not those with click-through licenses like
Sun’s. Therefore if you are going to build anything which is based on or uses
Sun’s libraries then you will need to download and install the relevant Sun Java libraries using this installation process
(see <a href="http://maven.apache.org/guides/mini/guide-coping-with-sun-jars.html">here</a> for more information).
</p>

<h2>Resolving Java libraries</h2>

<p>Once you have installed the Ant tasks for Apache Maven, in
order to specify the versions of libraries you wish to build against I
recommend creating a new properties file called <span style="font-family: monospace;">library.properties</span>.
You can then populate this file with the versions of libraries that you wish to
build against, for example:</p>

<pre name="code" class="python">
ver.hoteldejava.ejbclient = 1.1
ver.commons-net = 1.4.0
</pre>

<p>Since you are going to compile against these libraries,
you will need to setup a Java Classpath to contain them. Fortunately, the Ant
tasks for Apache Maven can do this for you automatically. To specify and resolve the Java libraries that you need and to automatically
create a new Classpath you would include the following in your
<span style="font-family: monospace;">build.xml</span>:</p>

<pre name="code" class="xml">
&lt;property file=&quot;build.properties&quot;/&gt;
&lt;property file=&quot;library.properties&quot;/&gt;

&lt;artifact:dependencies pathId=&quot;maven.classpath&quot;&gt;
    &lt;remoteRepository refid=&quot;internal.repository&quot;/&gt;
    &lt;dependency
        groupId=&quot;hoteldejava&quot;
        artifactId=&quot;ejbclient&quot;
        version=&quot;${ver.hoteldejava.ejbclient}&quot;/&gt;
    &lt;dependency
        groupId=&quot;commons-net&quot;
        artifactId=&quot;commons-net&quot;
        version=&quot;${ver.commons-net}&quot;/&gt;
&lt;/artifact:dependencies&gt;</p>
</pre>

<p>In this case I have specified that the Java libraries are
to be downloaded from the repository "internal.repository". The Ant tasks for Apache Maven
will therefore download the versions of the libraries from this repository to
the "<span style="font-family: monospace;">.m2</span>"
directory in your home directory &ndash; if they do not exist there already. If the
libraries that you require have dependencies on other libraries, these will be downloaded
too &ndash; this is the transitive dependencies feature in action. You can then use the
generated <span style="font-family: monospace;">maven.classpath</span>
in your Ant build script, for example to compile your project you could use a
line similar to the following:</p>

<div id="codeoutput">&lt;javac classpathref=&quot;maven.classpath&quot; &#0133/&gt;</div>

<p>If at a later date you require a different version of a library then you can simply
override the relevant entry in the <span style="font-family: monospace;">library.properties</span>
file. Additionally, if as a
developer you were doing some testing and did not want to update this file, you
could override the version on the command line (for example, using "
<span style="font-family: monospace;">ant &ndash;Dver.commons.cli=1.4.1</span>")
or make use of your own <span style="font-family: monospace;">build.properties</span> file.</p>

<h2>Publishing Java libraries</h2>

<p>As well as downloading pre-built libraries to build
against, you can also publish your own libraries to an Apache Maven repository.
This allows you to create a single consistent area for re-using libraries, and to take
advantage of Apache Maven’s dependency management capabilities. In order to
publish libraries, you will first need to create a <span style="font-family: monospace;">pom.xml</span> file. For
example, for the <i>Hotel de Java</i>
<i>EJBClient</i> project
this file would contain the following:</p>

<pre name="code" class="xml">
&lt;project&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;hoteldejava&lt;/groupId&gt;
    &lt;artifactId&gt;ejbclient&lt;/artifactId&gt;
    &lt;version&gt;1.0.1&lt;/version&gt;
&lt;/project&gt;
</pre>

<p>These are the only lines that you will need to be able to
publish a new library. However if applicable, you can also add dependencies to
the POM file similar to that for <span style="font-family: monospace;">commons-cli</span>
component described above.</p>

<p>To deploy your built library to the Maven repository, you would then
include a target in your <span style="font-family: monospace;">build.xml</span> file similar to the following:</p>

<pre name="code" class="xml">
&lt;target name=&quot;maven-deploy&quot;
    description=&quot;deploy to maven repository&quot;&gt;

    &lt;artifact:pom id=&quot;maven.project&quot;
        file=&quot;pom.xml&quot; /&gt;
    &lt;artifact:deploy file=&quot;dist/HotelDJEJBClient-${rel.num}.jar&quot;&gt;
        &lt;remoteRepository refid=&quot;internal.repository&quot;/&gt;
        &lt;pom refid=&quot;maven.project&quot;/&gt;
    &lt;/artifact:deploy&gt;
&lt;/target&gt;
</pre>

<p>In this example the library version is referenced by the
<span style="font-family: monospace;">${rel.num}</span> property
and it is being published to the repository "internal.repository".</p>

<p>In practice, this is all you will need to start using Apache Maven
repositories to implement Java library re-use and dependency management.
However there are additional settings and configurations that you can make
(such as specifying the location of your own local repository). These are
described in more detail on the Apache Ant tasks for Apache Maven website.</p>

<h2>References</h2>
<ul>
	<li><a href="http://maven.apache.org">Apache Maven home page</a></li>
	<li><a href="http://maven.apache.org/ant-tasks.html">Apache Ant tasks for Apache Maven</a></li>
</ul>

</div>