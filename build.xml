<?xml version="1.0" encoding="UTF-8"?>
<project name="buildmeister.com" default="help" basedir=".">
	
	<property name="dir.lib"	value="lib"/>
	<property name="dir.build"	value="build"/>
	<property name="dir.dist"	value="dist"/>
	<property name="dir.doc"	value="doc"/>
	<property environment="env"/>
		
	<property file="build.properties"/>
	<property file="default.properties"/>

	<!-- define a patternset for PHP Web sources -->
	<patternset id="php.sources">
	    <include name="**/*.htm*"/>		
		<include name="**/*.php"/>
	    <include name="**/*.swf"/>
	    <include name="**/*.js"/>
	    <include name="**/*.css"/>
	    <include name="**/*.gif"/>
		<include name="**/*.jpg"/>
	</patternset>
	
	<!-- define an internal classpath for -->
	<path id="internal.classpath">
    	<!-- include local libraries -->
    	<fileset dir="${dir.lib}"/>
	</path>
	
	<!-- create output directories -->
	<target name="init" description="create directory structure">
    	<mkdir dir="${dir.dist}"/>
    	<mkdir dir="${dir.doc}"/>
	</target>
	
	<!-- remove generated files -->
	<target name="clean" description="remove generated files">
    	<delete dir="${dir.dist}"/>
    	<delete dir="${dir.doc}"/>
	</target>

	<!-- static analysis -->
	
	<!-- phpdoc -->
	
	<!-- get a formatted release number -->
	<target name="get-relnum">
		<input message="Enter release Number:" addproperty="rel.num"/>
		<condition property="legal-relnum">
			<matches pattern="^\d\.\d.\d(-rc\d|-alpha\d|-beta\d)*$"
				 string="${rel.num}"/>
		</condition>
		<fail message="Error: the release number is not formatted correctly"
	    	  unless="legal-relnum"/>
		<propertyfile file="release.properties">
        		<entry key="rel.num" value="${rel.num}"/>
		</propertyfile>
	</target>
			
	<!-- prepare a release -->
	<target name="release-package" depends="get-relnum">
		<zip destfile="${ant.project.name}-${rel.num}.zip">
 			<fileset dir="${basedir}/..">
 				<include name="**/**/*"/>
 				<exclude name="**/build.properties"/>
 				<exclude name="**/release.properties"/>
			</fileset>
		</zip>
		<checksum file="${ant.project.name}-src-${rel.num}.zip"/>
	</target>
	
	<!-- deploy to development environment it env.dev property is set -->
	<target name="deploy2dev" if="env.dev">
		<property file="dev.properties"/>
		<copy overwrite="true" 
			file="include/template_constants.php" 
			tofile="include/constants.php"/>
		<echo>Replacing constants in include/constants.php</echo>
		<replace file="include/constants.php" propertyfile="dev.properties">
		  <replacefilter token="@db_server@" property="db.server"/>
		  <replacefilter token="@db_user@" property="db.user"/>
		  <replacefilter token="@db_pass@" property="db.pass"/>			
	      <replacefilter token="@db_name@" property="db.name"/>
		  <replacefilter token="@site_basedir@" property="site.basedir"/>
		</replace>
	</target>
	
	<!-- deploy to test environment if env.test property is set -->
	<target name="deploy2test" if="env.test">
		<property file="test.properties"/>
		<!-- not used -->
	</target>
	
	<!-- deploy to production environment if env.prod property is set -->
	<target name="deploy2prod" if="env.prod">
		<property file="prod.properties"/>
		<copy overwrite="true" 
			file="include/template_constants.php" 
			tofile="include/constants.php"/>
		<echo>Replacing constants in include/constants.php</echo>
		<replace file="include/constants.php" propertyfile="prod.properties">
		  <replacefilter token="@db_server@" property="db.server"/>
		  <replacefilter token="@db_user@" property="db.user"/>
		  <replacefilter token="@db_pass@" property="db.pass"/>			
	      <replacefilter token="@db_name@" property="db.name"/>
		  <replacefilter token="@site_basedir@" property="site.basedir"/>
		</replace>
		<!-- ftp files to server - requires apache commons.net -->
		<echo>FTP'ing files to ${ftp.server}</echo>
		<ftp server="${ftp.server}" userid="${ftp.user}"
			remotedir="${ftp.remotedir}" password="${ftp.pass}"
			passive="true" depends="true" verbose="true"
			skipfailedtransfers="true" retriesallowed="5">
 			<fileset dir="${basedir}">
 				<patternset refid="php.sources"/>
 			</fileset>
		</ftp>			
	</target>
	
	<!-- deploy to a specific environment -->
	<target name="deploy" depends="deploy2dev, deploy2test, deploy2prod"/>
	
	<!-- help -->
	<target name="help" description="display help">
    	<echo>build file for ${ant.project.name}</echo>
    	<echo>please type ant -p for description of all targets</echo>
	</target>

</project>