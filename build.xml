<?xml version="1.0" encoding="UTF-8"?>
<project name="buildmeister.com" default="help" basedir=".">
    
    <property name="dir.lib"    value="lib"/>
    <property name="dir.build"    value="build"/>
    <property name="dir.dist"    value="dist"/>
    <property name="dir.doc"    value="doc"/>
    <property environment="env"/>
        
    <property file="build.properties"/>
    <property file="default.properties"/>

    <!-- define a patternset for PHP Web sources -->
    <patternset id="php.sources">
        <include name="admin/**"/>        
	<include name="articles/**"/>     
	<include name="images/**"/>     
	<include name="include/**"/>     
	<include name="javascript/**"/>     
	<include name="stylesheets/**"/>     
        <exclude name="**/.svn/**"/>	
    </patternset>
    
    <!-- define an internal classpath for -->
    <path id="internal.classpath">
        <!-- include local libraries -->
        <fileset dir="${dir.lib}"/>
    </path>
    
    <!-- create output directories -->
    <target name="init" description="create directory structure">
        <mkdir dir="${dir.dist}"/>
        <mkdir dir="${dir.doc}"/>
    </target>
    
    <!-- remove generated files -->
    <target name="clean" description="remove generated files">
        <delete dir="${dir.dist}"/>
        <delete dir="${dir.doc}"/>
    </target>

    <!-- generate documentation -->
    <target name="phpdoc"> 
	    <phpdoc title="API Documentation"
	      destdir="apidocs"
	      sourcecode="no"
	      output="HTML:Smarty:PHP">
	       <fileset dir="./include">
		  <include name="**/*.php" />
	       </fileset>
	       <projdocfileset dir=".">
		       <include name="**/*.php" />
	       </projdocfileset>
	    </phpdoc>
    </target>
    
    <!-- get a formatted release number -->
    <target name="get-relnum">
        <input message="Enter release Number:" addproperty="rel.num"/>
        <!--condition property="legal-relnum">
            <matches pattern="^\d\.\d.\d(-rc\d|-alpha\d|-beta\d)*$"
                 string="${rel.num}"/>
        </condition>
        <fail message="Error: the release number is not formatted correctly"
              unless="legal-relnum"/-->
        <propertyfile file="release.properties">
                <entry key="rel.num" value="${rel.num}"/>
        </propertyfile>
    </target>
            
    <!-- prepare a release -->
    <target name="release-package" depends="get-relnum">
        <zip destfile="${ant.project.name}-${rel.num}.zip">
             <fileset dir="${basedir}/..">
                 <include name="**/**/*"/>
                 <exclude name="**/build.properties"/>
                 <exclude name="**/release.properties"/>
            </fileset>
        </zip>
        <checksum file="${ant.project.name}-src-${rel.num}.zip"/>
    </target>

    <!-- get environment -->
    <target name="get-env">
	<input propertyname="environment">Enter environment name [dev|test|prod]</input>
    </target> 

    <!-- configure application for specific environment -->
    <target name="config" depends="get-env">
       <input propertyname="db.pass">Enter database password for ${environment}:</input>
	<property file="${environment}.properties"/>
        <copy overwrite="true" file="stylesheets/template_main.css" 
            tofile="stylesheets/main.css">
            <filterchain>
                <replacetokens begintoken="@" endtoken="@">
                  <token key="image_dir" value="${image.dir}" />
                </replacetokens>
            </filterchain>
        </copy>
        <copy overwrite="true" file="include/template_constants.php" 
            tofile="include/constants.php">
            <filterchain>
                <replacetokens begintoken="@" endtoken="@">
                    <token key="db_server" value="${db.server}" />
                    <token key="db_user" value="${db.user}" />
                    <token key="db_pass" value="${db.pass}" />
                    <token key="db_name" value="${db.name}" />
                    <token key="site_basedir" value="${site.basedir}" />
                </replacetokens>
            </filterchain>
        </copy>        
    </target>

    <!-- deploy application to specific environment --> 
    <target name="deploy" depends="config">
	<exec command="upload\FTPSync.exe prod /INCREMENTAL /FTPSYNCDATA:upload" />
    </target>

    <!-- help -->
    <target name="help" description="display help">
        <echo>build file for ${phing.project.name}</echo>
        <echo>please type ant -p for description of all targets</echo>
    </target>

</project>
